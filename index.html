<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n l√Ω thay/ƒë·ªï m·ª±c m√°y in</title>
    <style>
      :root {
        --bg: #0f172a;
        --panel: #111827;
        --muted: #94a3b8;
        --text: #e5e7eb;
        --primary: #22c55e;
        --primary-2: #16a34a;
        --warn: #f59e0b;
        --danger: #ef4444;
        --accent: #38bdf8;
        --row: #0b1220;
        --chip: #1f2937;
        --border: #1f2937;
        --shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
        --radius: 16px;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background: radial-gradient(
            1200px 600px at 10% -20%,
            rgba(56, 189, 248, 0.08),
            transparent
          ),
          radial-gradient(
            1200px 600px at 80% -10%,
            rgba(34, 197, 94, 0.08),
            transparent
          ),
          var(--bg);
        color: var(--text);
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
          Cantarell, Noto Sans, sans-serif;
        line-height: 1.5;
      }
      header {
        position: sticky;
        top: 0;
        z-index: 10;
        backdrop-filter: saturate(1.1) blur(6px);
        background: rgba(15, 23, 42, 0.6);
        border-bottom: 1px solid var(--border);
      }
      .wrap {
        max-width: 1200px;
        margin: 0 auto;
        padding: 16px 20px;
      }
      .hero {
        display: flex;
        gap: 16px;
        align-items: center;
      }
      .logo {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--accent), var(--primary));
        display: grid;
        place-items: center;
        font-weight: 800;
        color: #0b1220;
        box-shadow: var(--shadow);
      }
      h1 {
        font-size: 22px;
        margin: 0;
        letter-spacing: 0.2px;
      }
      .sub {
        color: var(--muted);
        font-size: 13px;
        margin-top: 2px;
      }
      .toolbar {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 12px;
        margin-top: 14px;
      }
      .filters,
      .actions {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .input,
      .select,
      .button {
        background: var(--chip);
        color: var(--text);
        border: 1px solid var(--border);
        padding: 10px 12px;
        border-radius: 10px;
        font-size: 14px;
      }
      .input {
        min-width: 220px;
      }
      .select {
        min-width: 160px;
      }
      .button {
        cursor: pointer;
        user-select: none;
        transition: transform 0.04s ease, opacity 0.15s ease;
      }
      .button:hover {
        opacity: 0.95;
      }
      .button:active {
        transform: translateY(1px);
      }
      .btn-primary {
        background: linear-gradient(135deg, var(--primary), var(--primary-2));
        border-color: transparent;
        color: #081216;
        font-weight: 600;
      }
      .btn-accent {
        background: linear-gradient(135deg, var(--accent), #0284c7);
        border-color: transparent;
        color: #06131a;
        font-weight: 600;
      }
      .btn-quiet {
        background: transparent;
        border-color: var(--border);
      }

      .panel {
        background: rgba(17, 24, 39, 0.7);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
        margin-top: 16px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }

      /* ‚úÖ Sticky CH·ªà cho b·∫£ng ch√≠nh */
      #table thead th {
        text-align: left;
        font-size: 12px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--muted);
        background: rgba(2, 6, 23, 0.95); /* ƒë·∫≠m h∆°n ƒë·ªÉ kh√¥ng th·∫•y h√†ng d∆∞·ªõi */
        border-bottom: 1px solid var(--border);
        padding: 12px 14px;
        position: sticky;
        top: var(--sticky-top);
        backdrop-filter: blur(6px);
        z-index: 6;
      }
      /* ƒê·ªám ƒë·ªÉ h√†ng ƒë·∫ßu kh√¥ng b·ªã che */
      #table tbody::before {
        content: "";
        display: block;
        height: calc(var(--sticky-top) + 4px);
      }

      tbody td {
        padding: 12px 14px;
        border-bottom: 1px dashed var(--border);
        font-size: 14px;
      }
      tbody tr:nth-child(odd) {
        background: rgba(2, 6, 23, 0.25);
      }
      tbody tr:hover {
        background: rgba(56, 189, 248, 0.06);
      }
      .badge {
        display: inline-flex;
        align-items: center;
        width: max-content;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid var(--border);
        background: var(--chip);
      }
      .badge.ok {
        border-color: #14532d;
        background: rgba(16, 185, 129, 0.12);
        color: #86efac;
      }
      .badge.warn {
        border-color: #7c2d12;
        background: rgba(245, 158, 11, 0.12);
        color: #fdba74;
      }
      .badge.danger {
        border-color: #7f1d1d;
        background: rgba(239, 68, 68, 0.12);
        color: #fca5a5;
      }
      .tag {
        font-size: 12px;
        color: var(--muted);
      }
      .row-actions {
        display: flex;
        gap: 6px;
      }
      .chip-btn {
        padding: 6px 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--chip);
        cursor: pointer;
        font-size: 12px;
      }
      .chip-btn:hover {
        background: rgba(56, 189, 248, 0.08);
      }
      .footer {
        color: var(--muted);
        text-align: center;
        font-size: 12px;
        padding: 18px 0 32px;
      }

      /* Pill xanh cho ng√†y thay */
      .date-pill {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--chip);
        font-size: 12px;
      }
      .date-pill.filled {
        border-color: #14532d;
        background: rgba(34, 197, 94, 0.18);
        color: #bbf7d0;
      }

      /* ‚ùå KH√îNG sticky cho b·∫£ng trong dialog */
      dialog thead th {
        position: static !important;
        top: auto !important;
        backdrop-filter: none !important;
        background: var(--chip) !important;
      }

      dialog {
        border: none;
        border-radius: 16px;
        background: var(--panel);
        color: var(--text);
        box-shadow: var(--shadow);
        width: min(680px, 92vw);
      }
      dialog::backdrop {
        background: rgba(2, 6, 23, 0.6);
        backdrop-filter: blur(2px);
      }
      .dialog-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
      }
      .dialog-body {
        padding: 16px;
        display: grid;
        gap: 10px;
      }
      .grid-2 {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
      }
      .field {
        display: grid;
        gap: 6px;
      }
      .field label {
        font-size: 12px;
        color: var(--muted);
      }
      .field input,
      .field select,
      .field textarea {
        background: var(--chip);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 14px;
      }
      .dialog-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        padding: 0 16px 16px;
      }

      @media (max-width: 820px) {
        .grid-2 {
          grid-template-columns: 1fr;
        }
      }
      #dropZone.dragover {
        outline: 2px dashed var(--accent);
        outline-offset: -6px;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="wrap">
        <div class="hero">
          <div class="logo">üñ®Ô∏è</div>
          <div>
            <h1>Qu·∫£n l√Ω thay/ƒë·ªï m·ª±c m√°y in</h1>
            <div class="sub">
              M·ªói 2 l·∫ßn ƒë·ªï m·ª±c ‚Üí thay h·ªôp m·ª±c. Theo d√µi & l∆∞u l·ªãch s·ª≠ thao t√°c.
            </div>
          </div>
        </div>
        <div class="toolbar">
          <div class="filters">
            <input
              id="search"
              class="input"
              placeholder="T√¨m theo ph√≤ng, model, m√£ m·ª±c..."
            />
            <select id="statusFilter" class="select">
              <option value="all">T·∫•t c·∫£ tr·∫°ng th√°i</option>
              <option value="ok">ƒêang b√¨nh th∆∞·ªùng</option>
              <option value="warn">C·∫ßn l∆∞u √Ω (1 l·∫ßn ƒë·ªï)</option>
              <option value="danger">ƒê·∫øn h·∫°n thay (‚â• 2)</option>
            </select>
            <select id="roomFilter" class="select">
              <option value="all">T·∫•t c·∫£ ph√≤ng/b·ªô ph·∫≠n</option>
            </select>
          </div>
          <div class="actions">
            <input type="file" id="csvInput" accept=".csv" hidden />
            <label for="csvInput" class="button btn-accent">Nh·∫≠p CSV</label>
            <button id="exportCsv" class="button btn-quiet">Xu·∫•t CSV</button>
            <button
              id="exportHistory"
              class="button btn-quiet"
              title="Xu·∫•t nh·∫≠t k√Ω ƒë·ªï/thay"
            >
              Xu·∫•t l·ªãch s·ª≠
            </button>
            <button id="addPrinter" class="button btn-primary">
              + Th√™m m√°y in
            </button>
            <button id="resetData" class="button btn-quiet">ƒê·∫∑t l·∫°i</button>
          </div>
        </div>
      </div>
    </header>

    <main class="wrap">
      <div
        class="panel"
        id="dropZone"
        title="K√©o & th·∫£ CSV v√†o ƒë√¢y ƒë·ªÉ nh·∫≠p d·ªØ li·ªáu"
      >
        <table id="table">
          <thead>
            <tr>
              <th style="width: 44px">#</th>
              <th>Ph√≤ng/B·ªô ph·∫≠n</th>
              <th>T√™n m√°y/Model</th>
              <th>M√£ h·ªôp m·ª±c</th>
              <th>L·∫ßn ƒë·ªï m·ª±c (t·ª´ l·∫ßn thay g·∫ßn nh·∫•t)</th>
              <th>L·∫ßn thay g·∫ßn nh·∫•t</th>
              <th>Ghi ch√∫</th>
              <th>Tr·∫°ng th√°i</th>
              <th>Thao t√°c</th>
              <th>L·ªãch s·ª≠</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="tag" style="margin-top: 8px">
        M·∫πo: Import CSV s·∫Ω <b>kh√¥ng g·ªôp</b> d√≤ng tr√πng ‚Äî m·ªói d√≤ng CSV = 1 d√≤ng
        d·ªØ li·ªáu.
      </div>
      <div class="footer">
        D·ªØ li·ªáu l∆∞u c·ª•c b·ªô (localStorage). C√≥ th·ªÉ xu·∫•t CSV danh s√°ch v√† CSV l·ªãch
        s·ª≠ ƒë·ªÉ l∆∞u tr·ªØ.
      </div>
    </main>

    <!-- Dialog th√™m/s·ª≠a -->
    <dialog id="editDlg">
      <div class="dialog-head">
        <strong id="dlgTitle">M√°y in</strong>
        <button class="chip-btn" onclick="editDlg.close()">ƒê√≥ng</button>
      </div>
      <div class="dialog-body">
        <div class="grid-2">
          <div class="field">
            <label>Ph√≤ng/B·ªô ph·∫≠n</label><input id="fRoom" />
          </div>
          <div class="field">
            <label>T√™n m√°y/Model</label><input id="fModel" />
          </div>
          <div class="field">
            <label>M√£ h·ªôp m·ª±c</label><input id="fCartridge" />
          </div>
          <div class="field">
            <label>L·∫ßn ƒë·ªï m·ª±c (t·ª´ l·∫ßn thay g·∫ßn nh·∫•t)</label
            ><input id="fRefillCnt" type="number" min="0" />
          </div>
          <div class="field">
            <label>Ng√†y thay g·∫ßn nh·∫•t</label
            ><input id="fLastReplace" type="date" />
          </div>
          <div class="field"><label>Ghi ch√∫</label><input id="fNote" /></div>
        </div>
      </div>
      <div class="dialog-actions">
        <button id="saveRow" class="button btn-primary">L∆∞u</button>
      </div>
    </dialog>

    <!-- Dialog l·ªãch s·ª≠ -->
    <dialog id="historyDlg">
      <div class="dialog-head">
        <strong>L·ªãch s·ª≠ thao t√°c</strong>
        <button class="chip-btn" onclick="historyDlg.close()">ƒê√≥ng</button>
      </div>
      <div class="dialog-body">
        <div id="historyTitle" class="tag"></div>
        <table style="width: 100%; border-collapse: collapse">
          <thead>
            <tr>
              <th
                style="
                  text-align: left;
                  padding: 8px;
                  border-bottom: 1px solid var(--border);
                "
              >
                TH·ªúI ƒêI·ªÇM
              </th>
              <th
                style="
                  text-align: left;
                  padding: 8px;
                  border-bottom: 1px solid var(--border);
                "
              >
                H√ÄNH ƒê·ªòNG
              </th>
              <th
                style="
                  text-align: left;
                  padding: 8px;
                  border-bottom: 1px solid var(--border);
                "
              >
                GHI CH√ö
              </th>
              <th
                style="
                  text-align: left;
                  padding: 8px;
                  border-bottom: 1px solid var(--border);
                "
              >
                THAO T√ÅC
              </th>
            </tr>
          </thead>
          <tbody id="historyTbody"></tbody>
        </table>
        <div class="tag" style="margin-top: 8px">
          * H·ªá th·ªëng t·ª± ghi nh·∫≠n m·ªói l·∫ßn b·∫•m <b>+ ƒê·ªï</b> ho·∫∑c <b>‚úì Thay</b>.
        </div>
      </div>
    </dialog>

    <script>
      const KEY = "printer-toner-tracker:v1";
      const EXAMPLE = [
        {
          id: genId(),
          room: "VƒÉn ph√≤ng",
          model: "HP LaserJet Pro M404",
          cartridge: "CF258A",
          refillCnt: 0,
          lastReplace: "",
          note: "",
          history: [],
        },
        {
          id: genId(),
          room: "Ph√≤ng K·∫ø to√°n",
          model: "Canon LBP 223dw",
          cartridge: "057/057H",
          refillCnt: 1,
          lastReplace: "2025-06-01",
          note: "ƒê√£ ƒë·ªï 1 l·∫ßn",
          history: [{ ts: "2025-06-01", action: "replace", note: "Kh·ªüi t·∫°o" }],
        },
        {
          id: genId(),
          room: "Ph√≤ng K·ªπ thu·∫≠t",
          model: "Brother HL-L2375DW",
          cartridge: "TN-2385",
          refillCnt: 2,
          lastReplace: "2025-05-15",
          note: "ƒê·∫øn h·∫°n thay",
          history: [{ ts: "2025-05-15", action: "replace" }],
        },
      ];

      let rows = load().map((r) => ({
        ...r,
        history: Array.isArray(r.history) ? r.history : [],
      }));
      let editingId = null;

      const tbody = document.getElementById("tbody");
      const search = document.getElementById("search");
      const statusFilter = document.getElementById("statusFilter");
      const roomFilter = document.getElementById("roomFilter");
      const csvInput = document.getElementById("csvInput");
      const dropZone = document.getElementById("dropZone");
      const exportBtn = document.getElementById("exportCsv");
      const exportHistoryBtn = document.getElementById("exportHistory");
      const addBtn = document.getElementById("addPrinter");
      const resetBtn = document.getElementById("resetData");

      const editDlg = document.getElementById("editDlg");
      const fRoom = document.getElementById("fRoom");
      const fModel = document.getElementById("fModel");
      const fCartridge = document.getElementById("fCartridge");
      const fRefillCnt = document.getElementById("fRefillCnt");
      const fLastReplace = document.getElementById("fLastReplace");
      const fNote = document.getElementById("fNote");

      const historyDlg = document.getElementById("historyDlg");

      /* ---- Utils ---- */
      function genId() {
        return crypto && crypto.randomUUID
          ? crypto.randomUUID()
          : "id-" +
              Math.random().toString(36).slice(2) +
              Date.now().toString(36);
      }
      function load() {
        try {
          const raw = localStorage.getItem(KEY);
          if (!raw) return EXAMPLE;
          const p = JSON.parse(raw);
          return Array.isArray(p) ? p : EXAMPLE;
        } catch {
          return EXAMPLE;
        }
      }
      function save() {
        localStorage.setItem(KEY, JSON.stringify(rows));
      }
      function escapeHtml(s = "") {
        const map = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;",
        };
        return String(s).replace(/[&<>"']/g, (ch) => map[ch]);
      }
      function statusOf(r) {
        const c = Number(r.refillCnt || 0);
        if (c >= 2) return { key: "danger", text: "ƒê·∫øn h·∫°n thay" };
        if (c === 1) return { key: "warn", text: "C·∫ßn l∆∞u √Ω (1 l·∫ßn ƒë·ªï)" };
        return { key: "ok", text: "ƒêang b√¨nh th∆∞·ªùng" };
      }

      function renderFilters() {
        const rooms = Array.from(
          new Set(rows.map((r) => (r.room || "").trim()).filter(Boolean))
        ).sort();
        const cur = roomFilter.value;
        roomFilter.innerHTML =
          '<option value="all">T·∫•t c·∫£ ph√≤ng/b·ªô ph·∫≠n</option>' +
          rooms
            .map(
              (r) =>
                `<option ${cur === r ? "selected" : ""}>${escapeHtml(
                  r
                )}</option>`
            )
            .join("");
      }

      function render() {
        const q = (search.value || "").toLowerCase(),
          s = statusFilter.value,
          rf = roomFilter.value;
        const filtered = rows.filter((r) => {
          const st = statusOf(r).key;
          const hit = [r.room, r.model, r.cartridge]
            .join(" ")
            .toLowerCase()
            .includes(q);
          const hitRoom = rf === "all" || (r.room || "") === rf;
          const hitStatus = s === "all" || s === st;
          return hit && hitRoom && hitStatus;
        });

        tbody.innerHTML = filtered
          .map((r, i) => {
            const st = statusOf(r);
            return `<tr>
          <td class="tag">${i + 1}</td>
          <td>${escapeHtml(r.room || "")}</td>
          <td>${escapeHtml(r.model || "")}</td>
          <td><code>${escapeHtml(r.cartridge || "")}</code></td>
          <td>${Number(r.refillCnt || 0)}</td>
          <td>${
            r.lastReplace
              ? `<span class="date-pill filled">${new Date(
                  r.lastReplace
                ).toLocaleDateString("vi-VN")}</span>`
              : '<span class="tag">(ch∆∞a c√≥)</span>'
          }</td>
          <td>${escapeHtml(r.note || "")}</td>
          <td><span class="badge ${st.key}">${st.text}</span></td>
          <td class="row-actions">
            <button class="chip-btn" title="ƒê·ªï m·ª±c +1" onclick="incRefill('${
              r.id
            }')">+ ƒê·ªï</button>
            <button class="chip-btn" title="Ghi nh·∫≠n ƒë√£ thay h·ªôp m·ª±c" onclick="markReplace('${
              r.id
            }')">‚úì Thay</button>
            <button class="chip-btn" onclick="openEdit('${r.id}')">S·ª≠a</button>
            <button class="chip-btn" onclick="removeRow('${r.id}')">Xo√°</button>
          </td>
          <td><button class="chip-btn" onclick="openHistory('${
            r.id
          }')">L·ªãch s·ª≠</button></td>
        </tr>`;
          })
          .join("");

        renderFilters();
      }

      /* ---- Actions ---- */
      function incRefill(id) {
        const iso = new Date().toISOString().slice(0, 10);
        rows = rows.map((r) => {
          if (r.id !== id) return r;
          const cnt = Number(r.refillCnt || 0) + 1;
          const history = Array.isArray(r.history) ? r.history.slice() : [];
          history.push({
            ts: iso,
            action: "refill",
            note: `ƒê·ªï m·ª±c l·∫ßn ${cnt}`,
          });
          return { ...r, refillCnt: cnt, history };
        });
        save();
        render();
      }
      function markReplace(id) {
        const iso = new Date().toISOString().slice(0, 10);
        rows = rows.map((r) => {
          if (r.id !== id) return r;
          const history = Array.isArray(r.history) ? r.history.slice() : [];
          const prev = r.lastReplace
            ? ` (tr∆∞·ªõc: ${new Date(r.lastReplace).toLocaleDateString("vi-VN")})`
            : "";
          history.push({
            ts: iso,
            action: "replace",
            note: `Thay h·ªôp m·ª±c${prev}`,
          });
          return { ...r, refillCnt: 0, lastReplace: iso, history };
        });
        save();
        render();
      }
      function removeRow(id) {
        if (!confirm("Xo√° m√°y in n√†y?")) return;
        rows = rows.filter((r) => r.id !== id);
        save();
        render();
      }
      function openEdit(id = null) {
        editingId = id;
        if (id) {
          const r = rows.find((x) => x.id === id) || {};
          fRoom.value = r.room || "";
          fModel.value = r.model || "";
          fCartridge.value = r.cartridge || "";
          fRefillCnt.value = Number(r.refillCnt || 0);
          fLastReplace.value = (r.lastReplace || "").slice(0, 10);
          fNote.value = r.note || "";
          document.getElementById("dlgTitle").textContent = "S·ª≠a m√°y in";
        } else {
          fRoom.value = fModel.value = fCartridge.value = fNote.value = "";
          fRefillCnt.value = 0;
          fLastReplace.value = "";
          document.getElementById("dlgTitle").textContent = "Th√™m m√°y in";
        }
        editDlg.showModal();
      }
      document.getElementById("saveRow").onclick = () => {
        const data = {
          room: fRoom.value.trim(),
          model: fModel.value.trim(),
          cartridge: fCartridge.value.trim(),
          refillCnt: Number(fRefillCnt.value || 0),
          lastReplace: fLastReplace.value || "",
          note: fNote.value.trim(),
        };
        if (editingId) {
          const old = rows.find((r) => r.id === editingId) || {};
          const history = Array.isArray(old.history) ? old.history : [];
          rows = rows.map((r) =>
            r.id === editingId ? { ...r, ...data, history } : r
          );
        } else {
          rows = [{ id: genId(), ...data, history: [] }, ...rows];
        }
        save();
        render();
        editDlg.close();
      };

      /* ---- History helpers ---- */
      function renderHistoryTable(printerId) {
        const r = rows.find((x) => x.id === printerId);
        if (!r) return;

        document.getElementById("historyTitle").textContent = `${
          r.room || ""
        } ‚Ä¢ ${r.model || ""}`;

        const list = Array.isArray(r.history)
          ? r.history.map((h, index) => ({ ...h, index })).reverse()
          : [];

        document.getElementById("historyTbody").innerHTML = list
          .map((h) => {
            const label =
              h.action === "replace"
                ? "Thay h·ªôp m·ª±c"
                : h.action === "refill"
                ? "ƒê·ªï m·ª±c"
                : h.action || "";

            return `<tr>
          <td style="padding:8px;border-bottom:1px dashed var(--border)">${(
            h.ts || ""
          ).toString()}</td>
          <td style="padding:8px;border-bottom:1px dashed var(--border)">${label}</td>
          <td style="padding:8px;border-bottom:1px dashed var(--border)">${escapeHtml(
            h.note || ""
          )}</td>
          <td style="padding:8px;border-bottom:1px dashed var(--border)">
            <button class="chip-btn" onclick="deleteHistoryEntry('${r.id}', ${
              h.index
            })">Xo√°</button>
          </td>
        </tr>`;
          })
          .join("");
      }

      /* ---- History dialog ---- */
      function openHistory(id) {
        renderHistoryTable(id);
        historyDlg.showModal();
      }

      function deleteHistoryEntry(printerId, index) {
        const printer = rows.find((x) => x.id === printerId);
        if (!printer || !Array.isArray(printer.history)) return;

        if (!confirm("Xo√° d√≤ng l·ªãch s·ª≠ n√†y?")) return;

        const newHistory = printer.history.slice();
        if (index < 0 || index >= newHistory.length) return;

        newHistory.splice(index, 1);

        rows = rows.map((r) =>
          r.id === printerId ? { ...r, history: newHistory } : r
        );

        save();
        render();
        renderHistoryTable(printerId);
      }

      /* ---- CSV import/export (append-all) ---- */
      csvInput.addEventListener("change", async (e) => {
        const file = e.target?.files?.[0];
        if (!file) return;
        await importCsvFileAppendAll(file);
        e.target.value = "";
      });
      ["dragenter", "dragover"].forEach((evt) =>
        dropZone.addEventListener(evt, (e) => {
          e.preventDefault();
          dropZone.classList.add("dragover");
        })
      );
      ["dragleave", "drop"].forEach((evt) =>
        dropZone.addEventListener(evt, (e) => {
          e.preventDefault();
          dropZone.classList.remove("dragover");
        })
      );
      dropZone.addEventListener("drop", async (e) => {
        const file = e.dataTransfer?.files?.[0];
        if (!file) return;
        await importCsvFileAppendAll(file);
      });

      function normalizeImportedRow(nr) {
        return {
          id: nr.id && String(nr.id).trim() ? String(nr.id).trim() : genId(),
          room: nr.room || "",
          model: nr.model || "",
          cartridge: nr.cartridge || "",
          refillCnt: Number(nr.refillCnt || 0),
          lastReplace: (nr.lastReplace || "").slice(0, 10),
          note: nr.note || "",
          history: Array.isArray(nr.history) ? nr.history : [],
        };
      }
      function appendAll(existingRows, parsedRows) {
        const existingIds = new Set(existingRows.map((r) => r.id));
        const newIds = new Set();
        const appended = parsedRows.map((nr) => {
          let r = normalizeImportedRow(nr);
          while (existingIds.has(r.id) || newIds.has(r.id)) {
            r.id = genId();
          }
          newIds.add(r.id);
          return r;
        });
        return existingRows.concat(appended);
      }
      async function importCsvFileAppendAll(file) {
        const text = await file.text();
        const newRows = parseCsv(text);
        if (!newRows.length) {
          alert("CSV kh√¥ng h·ª£p l·ªá ho·∫∑c r·ªóng.");
          return;
        }
        rows = appendAll(rows, newRows);
        save();
        render();
      }
      function csvCell(v) {
        if (v == null) return "";
        const s = String(v).replaceAll('"', '""');
        return /[",\n]/.test(s) ? `"${s}"` : s;
      }
      function parseCsv(text) {
        text = text.replace(/^\uFEFF/, "");
        const lines = text.split(/\r?\n/).filter(Boolean);
        if (!lines.length) return [];
        const headers = splitCsvLine(lines[0]).map((h) => h.trim());
        const idx = (name) =>
          headers.findIndex((h) => h.toLowerCase() === name.toLowerCase());
        const map = {
          id: idx("id"),
          room:
            idx("room") > -1
              ? idx("room")
              : idx("ph√≤ng") > -1
              ? idx("ph√≤ng")
              : idx("ph√≤ng/ b·ªô ph·∫≠n"),
          model: idx("model") > -1 ? idx("model") : idx("t√™n m√°y/model"),
          cartridge:
            idx("cartridge") > -1 ? idx("cartridge") : idx("m√£ h·ªôp m·ª±c"),
          refillCnt:
            idx("refillcnt") > -1 ? idx("refillcnt") : idx("l·∫ßn ƒë·ªï m·ª±c"),
          lastReplace:
            idx("lastreplace") > -1 ? idx("lastreplace") : idx("ng√†y thay"),
          note: idx("note") > -1 ? idx("note") : idx("ghi ch√∫"),
        };
        return lines
          .slice(1)
          .map((line) => {
            const cells = splitCsvLine(line);
            const pick = (i) => (i != null && i > -1 ? cells[i] || "" : "");
            const obj = {
              id: pick(map.id),
              room: pick(map.room),
              model: pick(map.model),
              cartridge: pick(map.cartridge),
              refillCnt: Number(pick(map.refillCnt) || 0),
              lastReplace: (pick(map.lastReplace) || "").slice(0, 10),
              note: pick(map.note),
            };
            if (!obj.room && !obj.model) return null;
            return obj;
          })
          .filter(Boolean);
      }
      function splitCsvLine(line) {
        const out = [];
        let cur = "";
        let inQ = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (inQ) {
            if (ch === '"') {
              if (line[i + 1] === '"') {
                cur += '"';
                i++;
              } else {
                inQ = false;
              }
            } else cur += ch;
          } else {
            if (ch === '"') inQ = true;
            else if (ch === ",") {
              out.push(cur);
              cur = "";
            } else cur += ch;
          }
        }
        out.push(cur);
        return out;
      }

      /* ---- Page init ---- */
      addBtn.addEventListener("click", () => openEdit(null));
      resetBtn.addEventListener("click", () => {
        if (confirm("Xo√° d·ªØ li·ªáu ƒë√£ l∆∞u trong tr√¨nh duy·ªát?")) {
          localStorage.removeItem(KEY);
          rows = EXAMPLE;
          render();
        }
      });
      search.addEventListener("input", render);
      statusFilter.addEventListener("change", render);
      roomFilter.addEventListener("change", render);

      function setStickyTop() {
        const h = document.querySelector("header");
        let px = h?.offsetHeight || 88;
        px = Math.min(Math.max(px, 56), 140); // clamp 56‚Äì140px ƒë·ªÉ tr√°nh ‚Äúƒë·ªôi‚Äù qu√° cao
        document.documentElement.style.setProperty("--sticky-top", px + "px");
      }
      setStickyTop();
      new ResizeObserver(setStickyTop).observe(
        document.querySelector("header")
      );
      window.addEventListener("resize", setStickyTop);

      render();
    </script>
  </body>
</html>
